min_copier_version: "9.0.0"

# Questions
project_name:
  type: str
  help: Project name

project_slug:
  type: str
  help: Project slug (folder name)
  default: "{{ project_name | lower | replace(' ', '-') | replace('_', '-') }}"

project_description:
  type: str
  help: Short description
  default: ""

stack_preset:
  type: str
  help: Choose a stack preset
  choices:
    - django
    - express-vue
    - none
  default: none

python_tooling:
  type: str
  help: Python dependency tooling (for Django)
  choices:
    - pip
    - poetry
    - uv
  default: "{% if stack_preset == 'django' %}poetry{% else %}pip{% endif %}"
  when: "{{ stack_preset == 'django' }}"

node_package_manager:
  type: str
  help: Node package manager (for Express + Vue)
  choices:
    - npm
    - pnpm
    - yarn
  default: npm
  when: "{{ stack_preset == 'express-vue' }}"

author_name:
  type: str
  help: Author name
  default: ""

license:
  type: str
  help: Choose a license
  choices:
    - MIT
    - Apache-2.0
    - Proprietary
  default: MIT

ci_provider:
  type: str
  help: CI provider
  choices:
    - github
    - gitlab
    - none
  default: github

use_docker:
  type: bool
  help: Include Docker baseline
  default: true

add_precommit:
  type: bool
  help: Include pre-commit configuration
  default: false

include_postgres:
  type: bool
  help: Include Postgres in docker-compose
  default: "{{ true if stack_preset == 'django' else false }}"
  when: "{{ stack_preset != 'none' }}"

include_monitoring:
  type: bool
  help: Include Prometheus + Grafana monitoring stack
  default: false
  when: "{{ use_docker }}"

deployment_mode:
  type: str
  help: Deployment mode (controls Traefik local)
  choices:
    - local
    - server
  default: local
  when: "{{ use_docker }}"

python_version:
  type: str
  help: Python version for CI matrix examples
  default: "3.12"
  when: "{{ stack_preset == 'django' }}"

django_port:
  type: int
  help: Django dev server port (docker-compose)
  default: 8000
  when: "{{ stack_preset == 'django' }}"

node_version:
  type: str
  help: Node version for CI matrix examples
  default: "20"
  when: "{{ stack_preset == 'express-vue' }}"

api_port:
  type: int
  help: API port (docker-compose)
  default: 4000
  when: "{{ stack_preset == 'express-vue' }}"

frontend_port:
  type: int
  help: Frontend dev server port (docker-compose)
  default: 5173
  when: "{{ stack_preset == 'express-vue' }}"

dockerhub_namespace:
  type: str
  help: Docker Hub namespace/org
  default: fredissimo
  when: "{{ stack_preset != 'none' }}"

web_image_name:
  type: str
  help: Docker image name for Django web
  default: "{{ project_slug }}-web"
  when: "{{ stack_preset == 'django' }}"

api_image_name:
  type: str
  help: Docker image name for API
  default: "{{ project_slug }}-api"
  when: "{{ stack_preset == 'express-vue' }}"

frontend_image_name:
  type: str
  help: Docker image name for frontend
  default: "{{ project_slug }}-frontend"
  when: "{{ stack_preset == 'express-vue' }}"

app_domain:
  type: str
  help: App domain (Traefik router)
  default: localhost
  when: "{{ use_docker and stack_preset != 'none' }}"

api_domain:
  type: str
  help: API domain (Traefik router)
  default: api.localhost
  when: "{{ use_docker and stack_preset == 'express-vue' }}"

grafana_domain:
  type: str
  help: Grafana domain (Traefik router)
  default: grafana.localhost
  when: "{{ use_docker and include_monitoring }}"

prometheus_domain:
  type: str
  help: Prometheus domain (Traefik router)
  default: prometheus.localhost
  when: "{{ use_docker and include_monitoring }}"

deploy_stack_name:
  type: str
  help: Docker Swarm stack name
  default: "{{ project_slug }}"
  when: "{{ use_docker and stack_preset != 'none' }}"

deploy_path:
  type: str
  help: Absolute path on server where repo is located
  default: "/opt/{{ project_slug }}"
  when: "{{ use_docker and stack_preset != 'none' }}"

preprod_host:
  type: str
  help: Preprod SSH host
  default: ""
  when: "{{ use_docker and stack_preset != 'none' }}"

prod_host:
  type: str
  help: Prod SSH host
  default: ""
  when: "{{ use_docker and stack_preset != 'none' }}"

deploy_user:
  type: str
  help: Deployment SSH user
  default: ""
  when: "{{ use_docker and stack_preset != 'none' }}"

# Copier behavior

_subdirectory: template
_answers_file: .copier-answers.yml

# Ensure slug safety
_validate_project_slug:
  - when: "{{ project_slug != project_slug | lower | replace(' ', '-') | replace('_', '-') }}"
    error: "project_slug should be lowercase and use dashes only."

# Conditional excludes
_exclude:
  - "{{ ('template/' ~ project_slug ~ '/docker-compose.yml') if not use_docker else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/docker') if not use_docker else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/docker-compose.server.yml') if not use_docker else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/.pre-commit-config.yaml') if not add_precommit else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/.github') if ci_provider != 'github' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/.gitlab-ci.yml') if ci_provider != 'gitlab' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/app') if stack_preset != 'django' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/app/requirements.txt') if (stack_preset == 'django' and python_tooling == 'poetry') else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/app/requirements-dev.txt') if (stack_preset == 'django' and python_tooling == 'poetry') else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/app/pyproject.toml') if (stack_preset == 'django' and python_tooling != 'poetry') else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/api') if stack_preset != 'express-vue' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/frontend') if stack_preset != 'express-vue' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/docker-compose.server.yml') if stack_preset == 'none' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/.env.deploy') if stack_preset == 'none' else '__copier_no_match__' }}"
  - "{{ ('template/' ~ project_slug ~ '/monitoring') if not include_monitoring else '__copier_no_match__' }}"

_tasks:
  - command: "python \"{{ _copier_conf.dst_path }}/{{ project_slug }}/scripts/create_env.py\" --stack {{ stack_preset }}{% if stack_preset == 'django' %} --django-port {{ django_port }}{% elif stack_preset == 'express-vue' %} --api-port {{ api_port }} --frontend-port {{ frontend_port }} --api-domain {{ api_domain }}{% endif %}{% if stack_preset != 'none' %} --include-postgres {{ include_postgres }}{% endif %}{% if include_monitoring %} --include-monitoring {{ include_monitoring }} --grafana-domain {{ grafana_domain }} --prometheus-domain {{ prometheus_domain }}{% endif %} --app-domain {{ app_domain }}"
